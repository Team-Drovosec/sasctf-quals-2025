import hashlib
from requests import Session
import json
import time

from nacl.encoding import Base64Encoder
from tonsdk.contract.wallet import Wallets
from tonsdk.utils import sign_message, Address

target_address = "UQB8sn/HnbfA2tp6YZb23AcGvDpvNvx230k67oyoVPUSMEg/"
timestamp = int(time.time())

ton_proof = {
    "proof":{
        "timestamp": timestamp,
        "domain":{
            "lengthBytes": 21,
            "value": "burmalda.task.sasc.tf"
        },
        "signature": "",
        "payload": "test_nonce_123"
    },
    "account":{
        "address": Address(target_address).to_string(is_user_friendly=False),
        "chain": "-239",
        "walletStateInit": "doesn't matter",
        "publicKey": "",
        "network": "-239"
    }
}


def get_message():
    wc, whash = ton_proof['account']['address'].split(':', maxsplit=2)
    message = bytearray()
    message.extend('ton-proof-item-v2/'.encode())
    message.extend(int(wc, 10).to_bytes(4, 'little'))
    message.extend(bytes.fromhex(whash))
    message.extend(ton_proof['proof']['domain']['lengthBytes'].to_bytes(4, 'little'))
    message.extend(ton_proof['proof']['domain']['value'].encode())
    message.extend(ton_proof['proof']['timestamp'].to_bytes(8, 'little'))
    message.extend(ton_proof['proof']['payload'].encode())

    signature_message = bytearray()
    signature_message.extend(bytes.fromhex('ffff'))
    signature_message.extend('ton-connect'.encode())
    signature_message.extend(hashlib.sha256(message).digest())

    return signature_message


def main():
    mnemonics, pub_k, priv_k, wallet = Wallets.create(Wallets.default_version, 0)
    ton_proof["account"]["publicKey"] = pub_k.hex()

    msg = bytes(get_message())
    signature = sign_message(hashlib.sha256(msg).digest(), priv_k, Base64Encoder).signature

    ton_proof["proof"]["signature"] = signature.decode()
    print(json.dumps(ton_proof, indent=4))

    s = Session()
    response = s.post('https://burmalda.task.sasc.tf/api/auth', json=ton_proof)
    print(response.status_code, response.text)

    response = s.get("https://burmalda.task.sasc.tf/api/users/me")
    print(response.status_code, response.text)
    print(s.cookies.get_dict())
    

if __name__ == "__main__":
    main()
